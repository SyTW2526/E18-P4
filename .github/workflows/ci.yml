name: CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  tests:
    name: Run tests (server + client)
    runs-on: ubuntu-latest
    # This workflow assumes you use an Atlas cluster for DB in CI.
    # Set a repository secret named `ATLAS_URI` with the MongoDB connection string.
    # If you prefer to run a local Mongo service in CI, remove the `env` below and
    # re-enable the `services: mongodb:` block.
    env:
      MONGO_TEST_URI: ${{ secrets.ATLAS_URI }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install client & server dependencies
        run: |
          cd server && npm ci
          cd ../client && npm ci

      - name: Fail if ATLAS_URI not provided
        run: |
          if [ -z "$MONGO_TEST_URI" ]; then
            echo "Secret ATLAS_URI is not set. Configure it in repository Settings → Secrets → Actions." >&2
            exit 1
          fi
        shell: bash

      - name: Prepare CHROME_BIN for Puppeteer
        run: |
          # attempt to get puppeteer path (will succeed after npm ci)
          if node -e "console.log(require('puppeteer').executablePath())" >/dev/null 2>&1; then
            echo "CHROME_BIN=$(node -e \"console.log(require('puppeteer').executablePath())\")" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Run server tests
        working-directory: server
        run: |
          npm test

      - name: Run client tests (headless)
        working-directory: client
        run: |
          npm run test:ci

      - name: Upload client coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: client-coverage
          path: client/coverage/client || client/coverage

  e2e:
    name: E2E tests (Selenium)
    runs-on: ubuntu-latest
    needs: tests
    env:
      ATLAS_URI: ${{ secrets.ATLAS_URI }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install server, client and e2e deps
        run: |
          cd server && npm ci
          cd ../client && npm ci
          cd ../e2e && npm ci

      - name: Start server
        run: |
          export ATLAS_URI="${{ secrets.ATLAS_URI }}"
          cd server
          # run server in background
          npm start &
          echo "Waiting for server to be ready..."
          npx wait-on http://localhost:5200
        shell: bash

      - name: Build and serve client
        run: |
          cd client
          npm run build --if-present
          # serve static built client; falls back to ng serve if build missing
          if [ -d "dist/client" ]; then
            npx http-server ./dist/client -p 4200 -a 127.0.0.1 &
          else
            npm run start -- --host 127.0.0.1 --port 4200 &
          fi
          npx wait-on http://localhost:4200
        shell: bash

      - name: Run E2E Mocha tests
        working-directory: e2e
        run: |
          npx mocha tests --reporter spec
        shell: bash
