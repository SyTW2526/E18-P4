name: CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  tests:
    name: Run tests (server + client)
    runs-on: ubuntu-latest
    # Prefer Atlas when provided via secrets. If not provided, run a local Mongo service.
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install client & server dependencies
        run: |
          cd server && npm ci
          cd ../client && npm ci

      - name: Note DB connection
        run: |
          if [ -z "${MONGO_TEST_URI}" ]; then
            echo "MONGO_TEST_URI is empty - this should not happen." >&2
            exit 1
          else
            echo "Using MONGO_TEST_URI=$MONGO_TEST_URI"
          fi
        shell: bash

      - name: Prepare CHROME_BIN for Puppeteer
        run: |
          # attempt to get puppeteer path (will succeed after npm ci)
          if node -e "console.log(require('puppeteer').executablePath())" >/dev/null 2>&1; then
            echo "CHROME_BIN=$(node -e \"console.log(require('puppeteer').executablePath())\")" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Set DB env vars
        env:
          ATLAS_SECRET: ${{ secrets.ATLAS_URI }}
        run: |
          if [ -n "$ATLAS_SECRET" ]; then
            echo "MONGO_TEST_URI=$ATLAS_SECRET" >> $GITHUB_ENV
            echo "ATLAS_URI=$ATLAS_SECRET" >> $GITHUB_ENV
          else
            echo "MONGO_TEST_URI=mongodb://localhost:27017" >> $GITHUB_ENV
            echo "ATLAS_URI=mongodb://localhost:27017" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Run server tests
        working-directory: server
        run: |
          npm test

      - name: Run client tests (headless)
        working-directory: client
        run: |
          npm run test:ci

      - name: Upload client coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: client-coverage
          path: client/coverage/client || client/coverage

  e2e:
    name: E2E tests (Selenium)
    runs-on: ubuntu-latest
    needs: tests
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install server, client and e2e deps
        run: |
          cd server && npm ci
          cd ../client && npm ci
          cd ../e2e && npm ci

      - name: Start server
        env:
          ATLAS_SECRET: ${{ secrets.ATLAS_URI }}
        run: |
          # Use Atlas if provided, otherwise point server at local Mongo service
          if [ -z "$ATLAS_SECRET" ]; then
            echo "ATLAS_URI not set, using local mongodb service"
            export ATLAS_URI="mongodb://localhost:27017"
          else
            export ATLAS_URI="$ATLAS_SECRET"
          fi
          cd server
          # run server in background
          npm start &
          echo "Waiting for server to be ready..."
          npx wait-on http://localhost:5200
        shell: bash

      - name: Build and serve client
        run: |
          cd client
          npm run build --if-present
          # serve static built client; falls back to ng serve if build missing
          if [ -d "dist/client" ]; then
            npx http-server ./dist/client -p 4200 -a 127.0.0.1 &
          else
            npm run start -- --host 127.0.0.1 --port 4200 &
          fi
          npx wait-on http://localhost:4200
        shell: bash

      - name: Run E2E Mocha tests
        working-directory: e2e
        run: |
          npx mocha tests --reporter spec
        shell: bash
